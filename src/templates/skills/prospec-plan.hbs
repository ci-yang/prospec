---
name: prospec-plan
description: "Plan Implementation | 規劃實作 - Convert User Story into technical implementation plan (plan.md) and change specification (delta-spec.md). Triggers: plan, design architecture, how to implement, 規劃, 設計架構, 怎麼實作"
---

# Prospec Plan Skill

## Activation

When triggered, briefly describe in the user's language:
- That you'll read the proposal.md and design an implementation plan
- You'll produce both plan.md and delta-spec.md
- Knowledge will be loaded progressively (Layer 1 then Layer 2 as needed)

## Startup Loading

1. Read `.prospec/changes/[name]/proposal.md` — parse User Story and ACs
2. Read `{{knowledge_base_path}}/_index.md` — identify related modules (Layer 1)
3. Read `{{constitution_path}}` — prepare Constitution check
4. **MANDATORY** — Read [`references/plan-format.md`](references/plan-format.md) for plan.md format
5. **MANDATORY** — Read [`references/delta-spec-format.md`](references/delta-spec-format.md) for delta-spec.md format

**Do NOT** load all module AI Knowledge at once. Load on demand.

## Progressive Knowledge Loading Strategy

| Layer | What to Load | When to Load |
|-------|-------------|--------------|
| 1 | `_index.md` | At startup — quickly identify related modules |
| 2 | Related module `README.md` | During architecture design — understand APIs and patterns |
| 3 | Source code | When technical questions arise — user can request explicitly |

## Core Workflow

### Phase 1: Parse proposal.md

Auto-identify the current change (from directory context or ask user), read and summarize User Story.

### Phase 2: Load Module Knowledge (Layer 2)

Find related modules from `_index.md`, load their `{{knowledge_base_path}}/modules/[name]/README.md`.

### Phase 3: Create Scaffolding

| Scenario | Action |
|----------|--------|
| plan.md doesn't exist | Create empty `plan.md` + `delta-spec.md`, update `metadata.yaml` status → `plan` |
| Already exists | Read and populate |

### Phase 4: Design plan.md

Follow `references/plan-format.md` format:
- **Overview**: Implementation strategy summary
- **Affected Modules**: Table of impacted modules and changes
- **Implementation Steps**: 4-8 steps with details
- **Risk Assessment**: Risks, impact, and mitigation strategies

### Phase 5: Generate delta-spec.md

Follow `references/delta-spec-format.md` format:
- **ADDED**: New requirements (REQ ID + Description + AC + Priority)
- **MODIFIED**: Changed requirements (Before/After/Reason)
- **REMOVED**: Removed requirements (Reason)

### Phase 6: Constitution Check

Compare against 3+ most relevant principles, focusing on architecture, testing, performance, and security.

### Phase 7: Summary + Next Steps

Suggest: `/prospec-tasks` or manual review.

## NEVER

- **NEVER** write code in plan.md — plan is about architecture and steps, not code
- **NEVER** load all module AI Knowledge at once — only load related modules (Layer 2 on demand)
- **NEVER** skip delta-spec.md — plan and delta-spec must be produced together
- **NEVER** forget to update metadata.yaml status to `plan`
- **NEVER** start planning without a proposal.md — guide user to create a Story first
- **NEVER** produce more than 10 Implementation Steps — too many means the Story scope is too large
- **NEVER** ignore existing module design patterns — new implementation should follow project conventions
- **NEVER** list risks in Risk Assessment without mitigation strategies

## Error Handling

| Scenario | Action |
|----------|--------|
| proposal.md not found | Guide user to run `/prospec-new-story` first |
| Insufficient module info | Offer options: continue with available info / pause to supplement Knowledge / load source code |
| Constitution conflict | Modify plan to comply (preferred) / document exception reasoning |

All generated files must be written in English.
