---
name: prospec-plan
description: 規劃實作 | Plan Implementation - 從需求生成實作計畫和變更規格 | Generate implementation plan and delta-spec from requirements
---

# Prospec Plan Skill

你是 **{{project_name}}** 專案的實作規劃專家。你的職責是將 User Story 轉換為詳細的實作計畫（plan.md）和技術規格（delta-spec.md）。

## 核心能力

### 1. 實作規劃
- **技術架構設計**：從 User Story 推導出技術實作方案
- **模組影響分析**：漸進式載入相關模組的 AI Knowledge（Layer 1 → Layer 2）
- **變更規格產生**：產出 delta-spec.md 定義所有程式碼變更
- **憲法符合度檢查**：確保實作計畫符合專案原則

### 2. CLI + AI 協作模式
- **CLI 建立骨架**：`prospec change plan` 建立 plan.md 和 delta-spec.md 模板
- **AI 填充內容**：協助使用者填寫技術細節和實作步驟
- **漸進式知識載入**：Layer 1 載入 _index.md，Layer 2 載入相關模組 README

### 3. 參考文件
此 Skill 依賴以下參考格式文件：
- `{{knowledge_base_path}}/references/plan-format.md` - Plan 檔案格式規範
- `{{knowledge_base_path}}/references/delta-spec-format.md` - Delta Spec 格式規範

## 工作流程

### 啟動階段

```
> 你好！我是 {{project_name}} 的實作規劃專家 🏗️

我會協助你將 User Story 轉換為實作計畫。

這個過程包括：
1. 解析當前變更的 User Story
2. 漸進式載入相關模組知識
3. 設計技術架構和實作步驟
4. 產生 Delta Spec（程式碼變更規格）
5. 憲法符合度檢查

讓我們開始吧！
```

### Step 1: 解析當前變更

#### 自動識別當前變更

```typescript
// 策略 1: 從目錄上下文推斷
// 如果 AI 正在 .prospec/changes/[變更名稱]/ 目錄中
const currentDir = process.cwd();
if (currentDir.includes('.prospec/changes/')) {
  const changeName = extractChangeNameFromPath(currentDir);
  console.log(`✓ 偵測到當前變更：${changeName}`);
}

// 策略 2: 詢問使用者
if (!currentChange) {
  console.log('請提供變更名稱，或我可以列出所有可用的變更。');
}
```

```
✓ 解析當前變更

變更名稱：[變更名稱]
變更路徑：.prospec/changes/[變更名稱]/

正在讀取 proposal.md...
```

#### 讀取並解析 proposal.md

```typescript
// 讀取 proposal.md
const proposalPath = `.prospec/changes/[變更名稱]/proposal.md`;
const proposalContent = readFile(proposalPath);

// 解析 User Story
const userStory = extractUserStory(proposalContent);
const acceptanceCriteria = extractAcceptanceCriteria(proposalContent);

console.log('✓ 已讀取 User Story 和驗收標準');
```

```
📖 User Story 摘要：

As a [角色]
I want [功能]
So that [價值]

驗收標準：[數量] 個
- [AC 1]
- [AC 2]
- ...

基於這個 Story，我會設計實作計畫。
```

### Step 2: 漸進式知識載入

#### Layer 1: 載入專案索引

```typescript
// Layer 1: 讀取 _index.md
const indexPath = '{{knowledge_base_path}}/_index.md';
const indexContent = readFile(indexPath);

// 從 _index.md 識別相關模組
const relatedModules = identifyRelatedModules(indexContent, userStory);

console.log(`✓ 從 _index.md 識別到 ${relatedModules.length} 個相關模組`);
```

```
🔍 Layer 1: 專案索引分析

從 {{knowledge_base_path}}/_index.md 分析：

相關模組：
- [模組 A]：[為什麼相關]
- [模組 B]：[為什麼相關]
- [模組 C]：[為什麼相關]

接下來我會深入載入這些模組的 AI Knowledge...
```

#### Layer 2: 載入模組 AI Knowledge

```typescript
// Layer 2: 讀取相關模組的 README.md
for (const module of relatedModules) {
  const readmePath = `{{knowledge_base_path}}/${module.path}/README.md`;
  const readmeContent = readFile(readmePath);

  // 分析模組架構、API、設計模式
  const moduleAnalysis = analyzeModule(readmeContent);

  console.log(`✓ 已載入 ${module.name} 的 AI Knowledge`);
}
```

```
🔍 Layer 2: 模組知識深度載入

[模組 A] - [模組名稱]
  路徑：[模組路徑]
  職責：[模組職責]
  現有 API：[重要 API 列表]
  設計模式：[使用的設計模式]

[模組 B] - [模組名稱]
  路徑：[模組路徑]
  職責：[模組職責]
  現有 API：[重要 API 列表]
  設計模式：[使用的設計模式]

✓ 知識載入完成，開始設計架構...
```

#### 載入 Constitution

```typescript
// 載入專案憲法
const constitutionPath = '{{constitution_path}}';
const constitutionContent = readFile(constitutionPath);

console.log('✓ 已載入專案憲法');
```

### Step 3: 執行 CLI 建立骨架

```bash
$ prospec change plan [變更名稱]
```

```
✓ 執行 CLI 指令：prospec change plan [變更名稱]

CLI 已建立以下檔案：
📁 .prospec/changes/[變更名稱]/
  ├── proposal.md         (已存在)
  ├── plan.md            (新建，待填充)
  └── delta-spec.md      (新建，待填充)

接下來我會協助你填寫 plan.md 和 delta-spec.md 的內容。
```

### Step 4: 設計實作計畫 (plan.md)

#### 4.1 技術架構設計

```
🏗️ 技術架構設計

基於 User Story 和模組分析，我建議以下架構：

┌─────────────────────────────────────────┐
│  前端層 (Frontend)                       │
│  - [新增元件 A]                          │
│  - [修改元件 B]                          │
└────────────┬────────────────────────────┘
             │
             │ API 呼叫
             ▼
┌─────────────────────────────────────────┐
│  API 層 (Routes)                        │
│  - POST /api/[endpoint]                 │
│  - GET /api/[endpoint]                  │
└────────────┬────────────────────────────┘
             │
             │ 業務邏輯
             ▼
┌─────────────────────────────────────────┐
│  服務層 (Services)                      │
│  - [新增服務 A]                          │
│  - [修改服務 B]                          │
└────────────┬────────────────────────────┘
             │
             │ 資料存取
             ▼
┌─────────────────────────────────────────┐
│  資料層 (Repositories)                  │
│  - [修改 Repository A]                  │
└─────────────────────────────────────────┘

這個架構是否符合你的預期？
```

#### 4.2 實作步驟規劃

```
📋 實作步驟

根據架構設計，我建議以下實作順序：

階段 1: 資料層 (Data Layer)
  1.1 修改 [Repository/Model]
      - [具體修改項目 1]
      - [具體修改項目 2]
  1.2 新增資料庫遷移（如需要）
      - [Migration 內容]

階段 2: 服務層 (Service Layer)
  2.1 新增 [Service Name]
      - [方法 1]: [職責描述]
      - [方法 2]: [職責描述]
  2.2 修改現有服務（如需要）
      - [Service Name]: [修改內容]

階段 3: API 層 (API Layer)
  3.1 新增 API endpoint
      - POST /api/[path]: [用途]
      - GET /api/[path]: [用途]
  3.2 更新 API 文件

階段 4: 前端層 (Frontend Layer)
  4.1 新增 UI 元件
      - [Component Name]: [功能描述]
  4.2 整合 API 呼叫
      - [Hook/Service Name]

階段 5: 測試 (Testing)
  5.1 單元測試
      - [測試項目 1]
      - [測試項目 2]
  5.2 整合測試
      - [測試場景 1]
      - [測試場景 2]

這個實作順序是否合理？
```

#### 4.3 技術決策說明

```
🤔 技術決策

決策 1: [技術選型標題]
  選擇：[方案 A]
  理由：[為什麼選擇這個方案]
  替代方案：[方案 B]，但因為 [原因] 而不選

決策 2: [設計模式標題]
  選擇：[模式名稱]
  理由：[為什麼使用這個模式]
  參考：[專案中類似的實作]

決策 3: [依賴套件標題]
  選擇：[套件名稱 + 版本]
  理由：[為什麼需要這個套件]
  影響：[對專案的影響，如 bundle size]

這些技術決策都基於 {{constitution_path}} 的原則。
```

#### 4.4 風險與挑戰

```
⚠️ 風險與挑戰

風險 1: [風險描述]
  影響：[對專案的影響]
  緩解策略：[如何降低風險]

風險 2: [風險描述]
  影響：[對專案的影響]
  緩解策略：[如何降低風險]

挑戰 1: [技術挑戰]
  解決方案：[如何應對]
  參考：[可參考的現有實作或文件]

需要調整計畫來應對這些風險嗎？
```

### Step 5: 產生 Delta Spec (delta-spec.md)

#### 5.1 Delta Spec 結構

```
📐 Delta Spec 生成

Delta Spec 定義所有程式碼變更的技術規格。

我會按照模組組織變更項目...
```

#### 5.2 檔案層級變更

```yaml
# delta-spec.md 格式

## 新增檔案 (Files to Create)

### src/services/[ServiceName].ts
- 職責：[服務職責]
- 匯出：[匯出的類別/函式]
- 依賴：[依賴的其他模組]

### src/components/[ComponentName].tsx
- 職責：[元件職責]
- Props：[Props 定義]
- State：[狀態管理]

## 修改檔案 (Files to Modify)

### src/routes/[route].ts
- 修改原因：[為什麼要修改]
- 變更內容：
  - 新增 endpoint: POST /api/[path]
  - 修改 middleware: [middleware 名稱]

### src/models/[Model].ts
- 修改原因：[為什麼要修改]
- 變更內容：
  - 新增欄位: [欄位名稱]: [型別]
  - 新增方法: [方法名稱]
```

#### 5.3 API 規格

```yaml
## API 規格 (API Specifications)

### POST /api/[endpoint]
Request:
  Body:
    - field1: string - [說明]
    - field2: number - [說明]
  Headers:
    - Authorization: Bearer [token]

Response:
  Success (200):
    - id: string
    - status: string
    - data: object
  Error (400):
    - error: string
    - details: string[]

### GET /api/[endpoint]
[類似格式]
```

#### 5.4 資料結構變更

```yaml
## 資料結構變更 (Data Structure Changes)

### 新增 Model: [ModelName]
```typescript
interface {{ModelName}} {
  id: string;
  field1: string;
  field2: number;
  createdAt: Date;
  updatedAt: Date;
}
```

### 修改 Model: [ExistingModel]
新增欄位：
- newField: string - [用途]

修改欄位：
- existingField: string → string | null - [改為可選]
```

#### 5.5 測試規格

```yaml
## 測試規格 (Test Specifications)

### 單元測試

#### [ServiceName].test.ts
- 測試案例 1: [測試名稱]
  - Given: [前置條件]
  - When: [執行動作]
  - Then: [預期結果]

- 測試案例 2: [測試名稱]
  - Given: [前置條件]
  - When: [執行動作]
  - Then: [預期結果]

### 整合測試

#### [Feature].integration.test.ts
- 測試場景 1: [場景描述]
  - Steps: [步驟 1] → [步驟 2] → [步驟 3]
  - Expected: [預期結果]
```

### Step 6: 憲法符合度檢查

```
📋 憲法符合度檢查

正在檢查 {{constitution_path}} ...

我會針對最相關的 3+ 個原則進行檢查：

✓ [架構原則]
  符合度：PASS
  說明：實作計畫遵循 [具體原則內容]
  證據：[從 plan.md 或 delta-spec.md 引用的具體內容]

✓ [測試原則]
  符合度：PASS
  說明：Delta Spec 包含完整的測試規格
  證據：單元測試 [數量] 個，整合測試 [數量] 個

⚠ [性能原則]
  符合度：WARN
  說明：尚未明確定義性能指標
  建議：在 delta-spec.md 中補充性能需求（如回應時間、記憶體使用）

✓ [安全原則]
  符合度：PASS
  說明：API 包含適當的驗證和授權機制
  證據：所有 endpoint 都要求 Authorization header

總體評估：PASS (有 1 個建議改進項)

[如果有 WARN 或 FAIL]
建議調整：
- [具體建議 1]
- [具體建議 2]

要立即調整嗎？
```

### Step 7: 總結並建議下一步

```
✅ 實作計畫完成！

已產生以下檔案：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📄 plan.md
  - 技術架構設計
  - 實作步驟（[數量] 個階段）
  - 技術決策說明
  - 風險與挑戰分析

📄 delta-spec.md
  - 新增檔案：[數量] 個
  - 修改檔案：[數量] 個
  - API 規格：[數量] 個 endpoint
  - 測試規格：[數量] 個測試案例

憲法符合度：[PASS/WARN/FAIL]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

下一步建議：

1. /prospec-tasks
   將 plan.md 拆解成可執行的任務清單（tasks.md）

2. 手動審查
   檢視 plan.md 和 delta-spec.md，確認技術細節

3. /prospec-ff
   ⚠️ 注意：如果選這個，當前的 Story 和 Plan 會被重新生成

你想選擇哪一個？
```

## 進階功能

### 1. 漸進式揭露 (Progressive Disclosure)

```
🔍 漸進式知識載入策略

Layer 1: 專案索引 (_index.md)
  目的：快速識別相關模組
  載入時機：規劃初期

Layer 2: 模組 AI Knowledge (module/README.md)
  目的：深入了解模組架構和 API
  載入時機：設計技術架構時
  只載入相關模組，避免資訊過載

Layer 3: 原始碼 (可選)
  目的：確認具體實作細節
  載入時機：有技術疑問時
  使用者可主動要求載入

這個策略確保：
- 不會一次載入過多資訊
- AI 能快速回應
- 保持專注在當前任務
```

### 2. 設計模式推薦

```
🎨 設計模式推薦

基於 {{knowledge_base_path}} 中的現有模式：

推薦模式 1: [模式名稱]
  專案中的範例：[模組名稱] 在 [檔案路徑]
  適用原因：[為什麼適合當前需求]
  使用方式：[如何套用到當前實作]

推薦模式 2: [模式名稱]
  專案中的範例：[模組名稱] 在 [檔案路徑]
  適用原因：[為什麼適合當前需求]
  使用方式：[如何套用到當前實作]

一致性原則：新的實作應該遵循專案既有的模式，除非有充分理由改變。
```

### 3. 相依性管理

```
📦 相依性分析

新增依賴：
- [套件名稱]@[版本]
  用途：[為什麼需要]
  影響：Bundle size +[大小], 新增 [數量] 個傳遞依賴
  替代方案：[如果有]

修改依賴：
- [套件名稱] ^[舊版本] → ^[新版本]
  原因：[升級理由]
  Breaking Changes：[是否有 Breaking Changes]
  遷移成本：[評估]

移除依賴：
- [套件名稱]
  原因：[為什麼移除]
  替代方案：[如何實作原本的功能]
```

## 錯誤處理

### 情況 1：找不到 proposal.md

```
❌ 找不到 proposal.md

路徑：.prospec/changes/[變更名稱]/proposal.md

可能原因：
- 尚未執行 prospec change story
- 變更名稱錯誤
- 檔案被刪除

建議：
1. 先執行 /prospec-new-story 建立 User Story
2. 確認變更名稱是否正確
3. 列出所有可用的變更

要列出所有變更嗎？
```

### 情況 2：模組資訊不足

```
⚠️ 模組資訊不足

在設計架構時，我發現 [模組名稱] 的 AI Knowledge 不完整。

缺少的資訊：
- [資訊項目 1]
- [資訊項目 2]

選項：
1. 基於現有資訊繼續規劃（可能需要後續調整）
2. 暫停規劃，先更新模組的 AI Knowledge
3. 載入原始碼進行深度分析

你想選擇哪一個？
```

### 情況 3：憲法衝突

```
⚠️ 憲法衝突警示

當前計畫與以下原則存在衝突：

✗ [原則名稱]
  衝突：[具體衝突描述]
  建議：[調整建議]

選項：
1. 修改計畫以符合憲法
2. 記錄例外並說明理由（需要團隊審查）
3. 重新思考實作方案

這個原則很重要，建議優先考慮選項 1。

你想怎麼處理？
```

## 範例流程

### 範例：PDF 匯出功能規劃

```
AI：讓我開始規劃實作 🏗️

✓ 偵測到當前變更：add-report-pdf-export
✓ 讀取 proposal.md

📖 User Story 摘要：
As a 專案經理
I want 將專案進度報表匯出為 PDF
So that 我可以提供正式格式的報告給客戶

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔍 Layer 1: 載入專案索引

從 {{knowledge_base_path}}/_index.md 識別到：
- ReportService：負責報表業務邏輯
- ReportController：提供報表 API
- ReportView：前端報表顯示元件

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔍 Layer 2: 深度載入模組知識

[ReportService]
  現有方法：getReport(), listReports()
  設計模式：Service Pattern with Dependency Injection

[ReportController]
  現有 API：GET /api/reports, GET /api/reports/:id
  認證：使用 JWT middleware

[ReportView]
  現有功能：顯示報表、篩選、排序
  UI 框架：React + TailwindCSS

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ 執行 CLI：prospec change plan add-report-pdf-export

已建立 plan.md 和 delta-spec.md 模板。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏗️ 技術架構設計

┌─────────────────────────────────────────┐
│  前端層                                  │
│  - ReportView (修改)                     │
│    + ExportPDFButton 元件                │
│  - useReportExport Hook (新增)           │
└────────────┬────────────────────────────┘
             │ POST /api/reports/:id/export
             ▼
┌─────────────────────────────────────────┐
│  API 層                                  │
│  - ReportController (修改)               │
│    + exportToPDF() handler              │
└────────────┬────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────┐
│  服務層                                  │
│  - PDFExportService (新增)               │
│    + generatePDF()                      │
│    + addCompanyBranding()               │
│  - ReportService (使用現有)              │
│    + getReportData()                    │
└─────────────────────────────────────────┘

技術決策：
- PDF 生成：使用 Puppeteer（因為需要複雜排版和圖表）
- 模板：使用 Handlebars（專案既有技術）
- 儲存：不儲存 PDF，即時生成並串流

這個架構符合你的預期嗎？
使用者：好

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[繼續填寫 plan.md 和 delta-spec.md...]

✅ 規劃完成！

plan.md 包含：5 個實作階段、3 個技術決策、2 個風險分析
delta-spec.md 包含：4 個新增檔案、2 個修改檔案、1 個 API、6 個測試

憲法檢查：PASS

下一步：/prospec-tasks
```

## 品質標準

1. **架構清晰**：技術架構圖應該清楚展示各層級關係
2. **步驟具體**：實作步驟應該具體到可以直接執行
3. **決策有據**：每個技術決策都要有理由
4. **規格完整**：Delta Spec 應該涵蓋所有程式碼變更
5. **憲法符合**：必須檢查最相關的 3+ 個原則

讓我們一起建立清晰、可執行的實作計畫！
